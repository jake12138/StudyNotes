[toc]
# 1 索引介绍
MySQL索引的建立对于MySQL的高效运行是很重要的，索引可以大大提高MySQL的检索速度。
创建索引时，你需要确保该索引是应用在 SQL 查询语句的条件(一般作为 WHERE 子句的条件)。
实际上，索引也是一张表，该表保存了主键与索引字段，并指向实体表的记录。
缺点：虽然索引大大提高了查询速度，同时却会降低更新表的速度，如对表进行INSERT、UPDATE和DELETE。因为更新表时，MySQL不仅要保存数据，还要保存一下索引文件。

建立索引会占用磁盘空间的索引文件。
# 2 添加索引
## 2.1 添加索引
```sql
CREATE INDEX <indexName> ON <table_name> (column_name)
```
示例：
```sql
# 给book表添加name索引，索引名为idx_name
create  index idx_name ON book(name);

# 给book表添加name,age的联合索引，索引名为idx_name
create  index idx_name ON book(name，age);
```
## 2.2 创建时添加索引
在创建索引的时候也可以添加索引
```sql
CREATE TABLE mytable(  
`ID` INT NOT NULL,   
`username` VARCHAR(16) NOT NULL,  
INDEX <indexName> (username(length))  
);  
```
注意对于varchar类型的字段，创建索引的时候要跟上用作索引的长度length，那么该字段的前length个字符就会被当作索引

## 添加唯一索引
添加唯一索引后，成为索引的那个字段不允许有重复的值
```sql
# 给book表添加name索引，索引名为idx_name
create unique index idx_name ON book(name);

# 给book表添加name,age的联合索引，索引名为idx_name
create unique  index idx_name ON book(name，age);
```

# 3 索引的底层原理
## 3.1 B+树
数据库存储索引的数据结构是B+树，之所以不用红黑数或二叉树，是因为在大数据下，红黑树的高度会变得不可控；二叉树在顺序插入的情况下会退化成链表。
在说B+树之前，先看看B树
**B树**：
- 叶节点具有相同的深度，叶节点的指针为空
- 所有索引元素不重复
- 叶节点的数据索引从左到右递增排列
![B树](img/mysql-02.png)
由此可见B树的一个节点上有多个元素，元素的值从左到右递增，这样可以有效控制树的高度。 

**B+树**：
- 非叶子节点不存储data，只存储索引(冗余)，可以放更多的索引
- 叶子节点包含所有索引字段
- 叶子节点用指针连接，提高区间访问的性能
![B+树](img/mysql-03.png)

图中的数字是索引，空格是存储指向下一个节点的指针。MySQL给B+树的节点设置的大小是16Kb, 给指向子节点的指针分配的内存占6字节。一般来说采用的主键索引类型是bigint(占8字节)。由此可以计算出一个节点可以存放约1170个索引，如果B+树的高度为3(设叶子节点的data占1字节)，那么整颗树可以存储的索引个数为1170x1170x16 = 21902400。 这样只需要一个高度为3的B+树就可以存储2千多万条索引，而且一般来说，MySQL的B+树根节点是常驻内存的，因此查找时可以减少一次磁盘IO


# 聚集索引
聚集索引的索引和数据是存放在同一个文件中的，例如MySQL中的InnoDB存储引擎用的就是聚集索引。
![聚集索引](img/mysql-05.png)
对于InnoDB, 索引和数据信息存储在.ibd文件下，表的结构信息存储在.frm文件下。

# 非聚集索引
非聚集索引的的索引文件和数据文件是分离的，比如MySQL的MyISAM存储引擎用的就是非聚集索引
![非聚集索引](img/mysql-04.png)
对于MyISAM存储引擎，索引是存储在.MYI文件下，数据是存储在.MYD文件下，表结构信息存储在.frm文件下。如上图中，存储索引的B+树下的叶子节点存储的是指向对应数据的磁盘文件地址。